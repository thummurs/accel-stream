<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Accelerometer + Weather Logger</title>
		<style>
			:root {
				--bg: #0f172a;
				--panel: #111827;
				--ink: #e5e7eb;
				--muted: #9ca3af;
				--accent: #22d3ee;
				--ok: #10b981;
				--warn: #f59e0b;
				--bad: #ef4444;
				--card: #0b1225;
				--border: #1f2937;
			}
			html,
			body {
				margin: 0;
				padding: 0;
				height: 100%;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Helvetica, Arial;
				background: var(--bg);
				color: var(--ink);
				display: flex;
				justify-content: center;
				align-items: flex-start;
			}
			main.card {
				width: min(95vw, 1000px);
				margin: 20px;
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 18px;
				padding: 20px;
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
			}
			h1 {
				margin: 0 0 8px;
				font-size: 22px;
				text-align: center;
			}
			p.meta {
				text-align: center;
				color: var(--muted);
				margin: 0 0 16px;
				font-size: 13px;
			}
			.row {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				align-items: center;
				gap: 10px;
				margin-bottom: 14px;
			}
			button {
				all: unset;
				cursor: pointer;
				font-weight: 600;
				padding: 10px 16px;
				border-radius: 10px;
				text-align: center;
				min-width: 160px;
				background: #1f2937;
				border: 1px solid #293241;
			}
			button.primary {
				background: var(--accent);
				color: #052b33;
				border-color: #0ea5b6;
			}
			button.warn {
				background: #1f2937;
				border-color: #334155;
				color: #fca5a5;
			}
			button[disabled] {
				opacity: 0.45;
				cursor: not-allowed;
			}
			.led {
				width: 10px;
				height: 10px;
				border-radius: 50%;
				display: inline-block;
				margin-right: 8px;
				vertical-align: middle;
			}
			.led.on {
				background: var(--ok);
				box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
			}
			.led.off {
				background: #374151;
			}
			.grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
				gap: 10px;
				margin-top: 12px;
			}
			.tile {
				background: #0b142a;
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 8px 6px 10px;
				text-align: center;
			}
			.label {
				color: var(--muted);
				font-size: 12px;
				margin-bottom: 4px;
			}
			.val {
				font-variant-numeric: tabular-nums;
				font-size: 22px;
			}
			.ballWrap {
				margin-top: 18px;
				height: 160px;
				background: #081021;
				border: 1px solid #14203b;
				border-radius: 14px;
				position: relative;
				overflow: hidden;
			}
			.ball {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				position: absolute;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				background: radial-gradient(
					circle at 30% 30%,
					#fff 0,
					#abdff5 25%,
					#22d3ee 70%,
					#0ea5b6 100%
				);
				box-shadow: 0 6px 18px rgba(34, 211, 238, 0.35);
			}
			.footer {
				margin-top: 14px;
				color: var(--muted);
				font-size: 12px;
				text-align: center;
			}
			.weatherWrap {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
				gap: 10px;
				margin-top: 14px;
			}
			.chip {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				background: #0b142a;
				border: 1px solid var(--border);
				padding: 6px 10px;
				border-radius: 999px;
				font-size: 12px;
				color: var(--muted);
			}
		</style>
	</head>
	<body>
		<main class="card">
			<h1>Accelerometer + Weather Logger</h1>
			<p class="meta">Real-time accelerometer + weather streaming</p>

			<div class="row">
				<span class="led off" id="led"></span>
				<span id="status">Idle</span>
				<button id="btnPerm" class="primary">Grant Motion + Location</button>
				<button id="btnStart" disabled>Start</button>
				<button id="btnStop" disabled class="warn">Stop</button>
				<button id="btnCloud" disabled>Start Cloud Stream</button>
			</div>

			<div class="grid">
				<div class="tile">
					<div class="label">Time (s)</div>
					<div class="val" id="timeVal">0.000</div>
				</div>
				<div class="tile">
					<div class="label">Interval (ms)</div>
					<div class="val" id="dtVal">â€”</div>
				</div>
				<div class="tile">
					<div class="label">Samples</div>
					<div class="val" id="nVal">0</div>
				</div>
			</div>
			<div class="grid">
				<div class="tile">
					<div class="label">ax</div>
					<div class="val" id="axVal">0.00</div>
				</div>
				<div class="tile">
					<div class="label">ay</div>
					<div class="val" id="ayVal">0.00</div>
				</div>
				<div class="tile">
					<div class="label">az</div>
					<div class="val" id="azVal">0.00</div>
				</div>
			</div>
			<div class="grid">
				<div class="tile">
					<div class="label">|a|</div>
					<div class="val" id="amagVal">0.00</div>
				</div>
				<div class="tile">
					<div class="label">HPF |a|</div>
					<div class="val" id="amagHPFVal">0.00</div>
				</div>
				<div class="tile">
					<div class="label">Hz</div>
					<div class="val" id="hzVal">â€”</div>
				</div>
			</div>

			<div class="ballWrap"><div id="ball" class="ball"></div></div>

			<div class="weatherWrap">
				<div class="tile">
					<div class="label">Temp</div>
					<div class="val">
						<span id="wTemp">--</span>
						Â°C
						<span id="wIcon">â›…</span>
					</div>
					<div class="label" id="wDesc">â€”</div>
				</div>
				<div class="tile">
					<div class="label">Wind</div>
					<div class="val">
						<span id="wWind">--</span>
						km/h
					</div>
					<div class="label">
						Dir
						<span id="wDir">--</span>
						Â° |
						<span id="wDay">Day/Night</span>
					</div>
				</div>
				<div class="tile">
					<div class="label">Last Weather</div>
					<div class="val" id="wLast">â€”</div>
					<div class="chip">
						<input
							id="useGPS"
							type="checkbox"
							style="accent-color: #22d3ee; margin-right: 6px"
						/>
						Use GPS
					</div>
				</div>
			</div>

			<div class="footer">iPhone sensors + weather â†’ Firebase</div>
		</main>

		<script type="module">
			import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'
			import {
				getAuth,
				signInAnonymously,
				onAuthStateChanged,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js'
			import {
				getFirestore,
				collection,
				addDoc,
				serverTimestamp,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'

			const firebaseConfig = {
				apiKey: 'AIzaSyAu7YQkG2xRPNs9aGN4TUS3_LpInye72WA',
				authDomain: 'uc-assignment-3-7ac2a.firebaseapp.com',
				projectId: 'uc-assignment-3-7ac2a',
				storageBucket: 'uc-assignment-3-7ac2a.firebasestorage.app',
				messagingSenderId: '369697845903',
				appId: '1:369697845903:web:05bccb3b0e7ba24c65b6fa',
				measurementId: 'G-9BNGZDZ8VQ',
			}
			const app = initializeApp(firebaseConfig)
			const auth = getAuth(app)
			const db = getFirestore(app)
			const accelCol = collection(db, 'accelerometerData')
			const weatherCol = collection(db, 'weatherData')

			const led = document.getElementById('led'),
				statusEl = document.getElementById('status'),
				btnPerm = document.getElementById('btnPerm'),
				btnStart = document.getElementById('btnStart'),
				btnStop = document.getElementById('btnStop'),
				btnCloud = document.getElementById('btnCloud')
			const timeVal = document.getElementById('timeVal'),
				dtVal = document.getElementById('dtVal'),
				nVal = document.getElementById('nVal'),
				hzVal = document.getElementById('hzVal'),
				axVal = document.getElementById('axVal'),
				ayVal = document.getElementById('ayVal'),
				azVal = document.getElementById('azVal'),
				amagVal = document.getElementById('amagVal'),
				amagHPFVal = document.getElementById('amagHPFVal'),
				ball = document.getElementById('ball')
			const wTemp = document.getElementById('wTemp'),
				wIcon = document.getElementById('wIcon'),
				wDesc = document.getElementById('wDesc'),
				wWind = document.getElementById('wWind'),
				wDir = document.getElementById('wDir'),
				wDay = document.getElementById('wDay'),
				wLast = document.getElementById('wLast'),
				useGPS = document.getElementById('useGPS')

			let isActive = false,
				cloudMode = false,
				startT,
				lastT,
				n = 0,
				sumDt = 0,
				gx = 0,
				gy = 0,
				gz = 0,
				lastWrite = 0
			let lat = 53.3498,
				lon = -6.2603,
				weatherTimer

			function s(t, on) {
				statusEl.textContent = t
				led.className = 'led ' + (on ? 'on' : 'off')
			}
			btnStart.disabled = true
			btnPerm.disabled = true
			signInAnonymously(auth)
			onAuthStateChanged(auth, () => (btnPerm.disabled = false))

			async function requestAllPermissions() {
				try {
					if (
						typeof DeviceMotionEvent !== 'undefined' &&
						typeof DeviceMotionEvent.requestPermission === 'function'
					) {
						const st = await DeviceMotionEvent.requestPermission()
						if (st !== 'granted') throw 0
					}
					await new Promise((res, rej) =>
						navigator.geolocation.getCurrentPosition(
							(p) => {
								if (useGPS.checked) {
									lat = p.coords.latitude
									lon = p.coords.longitude
								}
								res()
							},
							() => rej()
						)
					)
					btnPerm.disabled = true
					btnStart.disabled = false
					s('Permissions granted')
					fetchWeather()
					weatherTimer = setInterval(fetchWeather, 30000)
				} catch {
					alert('Permission required')
				}
			}

			async function fetchWeather() {
				try {
					const r = await fetch(
						`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
					)
					const w = (await r.json()).current_weather
					if (!w) return
					const M = {
						0: ['Clear', 'â˜€ï¸'],
						1: ['Mainly Clear', 'ðŸŒ¤ï¸'],
						2: ['Partly Cloudy', 'â›…'],
						3: ['Overcast', 'â˜ï¸'],
						61: ['Light Rain', 'ðŸŒ§ï¸'],
						63: ['Rain', 'ðŸŒ§ï¸'],
						65: ['Heavy Rain', 'â›ˆï¸'],
					}
					const d = M[w.weathercode] || ['Unknown', 'ðŸŒ¡ï¸']
					wTemp.textContent = w.temperature
					wIcon.textContent = d[1]
					wDesc.textContent = d[0]
					wWind.textContent = w.windspeed
					wDir.textContent = w.winddirection
					wDay.textContent = w.is_day ? 'Day' : 'Night'
					wLast.textContent = new Date().toLocaleTimeString()
					await addDoc(weatherCol, {
						ts: serverTimestamp(),
						lat,
						lon,
						temperature: w.temperature,
						wind: w.windspeed,
						dir: w.winddirection,
						code: w.weathercode,
						is_day: w.is_day,
					})
				} catch (e) {}
			}

			function start() {
				isActive = true
				startT = performance.now()
				lastT = startT
				n = 0
				sumDt = 0
				gx = gy = gz = 0
				btnStart.disabled = true
				btnStop.disabled = false
				btnCloud.disabled = false
				s('Recording', true)
				window.addEventListener('devicemotion', onMotion, { passive: true })
			}

			function stop() {
				isActive = false
				window.removeEventListener('devicemotion', onMotion, { passive: true })
				btnStart.disabled = false
				btnStop.disabled = true
				btnCloud.disabled = true
				cloudMode = false
				btnCloud.textContent = 'Start Cloud Stream'
				s('Stopped')
			}

			function onMotion(e) {
				if (!isActive) return
				const t = performance.now(),
					dt = (t - lastT) / 1000
				lastT = t
				const a = e.acceleration || e.accelerationIncludingGravity || {},
					ax = a.x || 0,
					ay = a.y || 0,
					az = a.z || 0
				gx = 0.92 * gx + 0.08 * ax
				gy = 0.92 * gy + 0.08 * ay
				gz = 0.92 * gz + 0.08 * az
				const lx = ax - gx,
					ly = ay - gy,
					lz = az - gz
				const amag = Math.hypot(ax, ay, az),
					amagHPF = Math.hypot(lx, ly, lz)
				if (n > 0) sumDt += dt
				n++
				timeVal.textContent = ((t - startT) / 1000).toFixed(3)
				dtVal.textContent = (dt * 1000).toFixed(1)
				nVal.textContent = n
				hzVal.textContent = n > 1 ? (1 / (sumDt / (n - 1))).toFixed(2) : 'â€”'
				axVal.textContent = ax.toFixed(2)
				ayVal.textContent = ay.toFixed(2)
				azVal.textContent = az.toFixed(2)
				amagVal.textContent = amag.toFixed(2)
				amagHPFVal.textContent = amagHPF.toFixed(2)
				const bx = Math.max(-100, Math.min(100, lx * 3)),
					by = Math.max(-60, Math.min(60, ly * 3))
				ball.style.transform = `translate(calc(-50% + ${bx}px), calc(-50% + ${by}px))`
				if (cloudMode) {
					const now = performance.now()
					if (now - lastWrite >= 100) {
						lastWrite = now
						addDoc(accelCol, {
							ts: serverTimestamp(),
							time: (t - startT) / 1000,
							ax,
							ay,
							az,
							lx,
							ly,
							lz,
							amag,
							amagHPF,
						})
					}
				}
			}

			btnPerm.onclick = requestAllPermissions
			btnStart.onclick = start
			btnStop.onclick = stop
			btnCloud.onclick = () => {
				cloudMode = !cloudMode
				btnCloud.textContent = cloudMode ? 'Streamingâ€¦' : 'Start Cloud Stream'
			}
			window.onbeforeunload = () => {
				if (isActive) stop()
			}
			document.onvisibilitychange = () => {
				if (document.hidden && isActive) stop()
			}
		</script>
	</body>
</html>
