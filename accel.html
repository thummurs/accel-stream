<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Accelerometer Logger</title>
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}
			:root {
				--bg: #0b1021;
				--panel: #0e152b;
				--card: #0b142a;
				--ink: #e7eaf0;
				--muted: #9aa3b2;
				--accent: #22d3ee;
				--accent-ink: #052b33;
				--border: #1b2740;
				--ok: #10b981;
			}
			html,
			body {
				margin: 0;
				height: 100%;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Helvetica, Arial;
				background: var(--bg);
				color: var(--ink);
			}
			body {
				display: flex;
				justify-content: center;
				align-items: flex-start;
				padding: max(16px, env(safe-area-inset-top)) 16px
					max(16px, env(safe-area-inset-bottom));
				-webkit-text-size-adjust: 100%;
			}
			main.card {
				width: 100%;
				max-width: 440px;
				background: var(--panel);
				border: 1px solid var(--border);
				border-radius: 18px;
				padding: 16px;
				box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
				overflow: hidden;
			}
			h1 {
				margin: 0 0 10px;
				text-align: center;
				font-size: 22px;
			}
			.row {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 14px;
				margin: 0 0 12px;
				padding: 0 10px;
			}
			.row.status {
				gap: 8px;
				font-size: 14px;
				color: var(--muted);
			}
			.led {
				width: 9px;
				height: 9px;
				border-radius: 50%;
			}
			.led.on {
				background: var(--ok);
				box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.18);
			}
			.led.off {
				background: #44506b;
			}
			.btncol {
				display: grid;
				grid-template-columns: 1fr;
				gap: 10px;
				width: 100%;
				max-width: 460px;
			}
			button {
				-webkit-appearance: none;
				appearance: none;
				display: block;
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;
				cursor: pointer;
				user-select: none;
				-webkit-tap-highlight-color: transparent;
				font: inherit;
				font-weight: 700;
				letter-spacing: 0.2px;
				text-align: center;
				padding: 14px 16px;
				border-radius: 12px;
				background: #152036;
				border: 1px solid #21304c;
				color: var(--ink);
				transition: transform 0.06s ease, border-color 0.15s ease,
					background 0.15s ease;
			}
			button:active {
				transform: translateY(1px);
			}
			button.primary {
				background: var(--accent);
				color: var(--accent-ink);
				border-color: #0ea5b6;
			}
			button.warn {
				color: #fda4a4;
			}
			button[disabled] {
				opacity: 0.55;
				cursor: not-allowed;
			}
			.grid {
				display: grid;
				gap: 12px;
				margin-top: 12px;
				grid-template-columns: repeat(2, minmax(0, 1fr));
			}
			@media (min-width: 500px) {
				.grid {
					grid-template-columns: repeat(3, minmax(0, 1fr));
				}
			}
			.tile {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 10px 8px;
				text-align: center;
				min-height: 80px;
				display: flex;
				flex-direction: column;
				justify-content: center;
			}
			.label {
				color: var(--muted);
				font-size: 12px;
				margin-bottom: 4px;
			}
			.val {
				font-variant-numeric: tabular-nums;
				font-size: 22px;
			}
			.ballWrap {
				margin-top: 12px;
				height: 140px;
				border-radius: 14px;
				background: #0a1228;
				border: 1px solid #14203b;
				position: relative;
				overflow: hidden;
			}
			.ball {
				width: 30px;
				height: 30px;
				border-radius: 50%;
				position: absolute;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				background: radial-gradient(
					circle at 30% 30%,
					#fff 0,
					#b8e9ff 26%,
					#22d3ee 70%,
					#0ea5b6 100%
				);
				box-shadow: 0 6px 18px rgba(34, 211, 238, 0.35);
			}
		</style>
	</head>
	<body>
		<main class="card">
			<h1>Accelerometer Logger</h1>

			<div class="row status">
				<span id="led" class="led off"></span>
				<span id="status">Stopped</span>
			</div>

			<div class="row">
				<div class="btncol">
					<button id="btnPermMotion" class="primary">Grant Motion</button>
					<button id="btnStart" disabled>Start Streaming</button>
					<button id="btnStop" disabled class="warn">Stop Streaming</button>
				</div>
			</div>

			<div class="grid">
				<div class="tile">
					<div class="label">Time (s)</div>
					<div id="timeVal" class="val">0.000</div>
				</div>
				<div class="tile">
					<div class="label">Interval (ms)</div>
					<div id="dtVal" class="val">—</div>
				</div>
				<div class="tile">
					<div class="label">Samples</div>
					<div id="nVal" class="val">0</div>
				</div>
				<div class="tile">
					<div class="label">Hz</div>
					<div id="hzVal" class="val">—</div>
				</div>
			</div>
			<div class="grid">
				<div class="tile">
					<div class="label">ax</div>
					<div id="axVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">ay</div>
					<div id="ayVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">az</div>
					<div id="azVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">|a|</div>
					<div id="amagVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">HPF |a|</div>
					<div id="amagHPFVal" class="val">0.00</div>
				</div>
			</div>

			<div class="ballWrap"><div id="ball" class="ball"></div></div>
		</main>

		<script type="module">
			import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'
			import {
				getAuth,
				signInAnonymously,
				onAuthStateChanged,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js'
			import {
				getFirestore,
				collection,
				addDoc,
				serverTimestamp,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'

			const firebaseConfig = {
				apiKey: 'AIzaSyAu7YQkG2xRPNs9aGN4TUS3_LpInye72WA',
				authDomain: 'uc-assignment-3-7ac2a.firebaseapp.com',
				projectId: 'uc-assignment-3-7ac2a',
				storageBucket: 'uc-assignment-3-7ac2a.firebasestorage.app',
				messagingSenderId: '369697845903',
				appId: '1:369697845903:web:05bccb3b0e7ba24c65b6fa',
				measurementId: 'G-9BNGZDZ8VQ',
			}

			const app = initializeApp(firebaseConfig)
			const auth = getAuth(app)
			const db = getFirestore(app)
			const colAccel = collection(db, 'accelerometerData')

			const led = document.getElementById('led'),
				statusEl = document.getElementById('status')
			const btnPerm = document.getElementById('btnPermMotion')
			const btnStart = document.getElementById('btnStart')
			const btnStop = document.getElementById('btnStop')

			const timeVal = document.getElementById('timeVal'),
				dtVal = document.getElementById('dtVal'),
				nVal = document.getElementById('nVal'),
				hzVal = document.getElementById('hzVal'),
				axVal = document.getElementById('axVal'),
				ayVal = document.getElementById('ayVal'),
				azVal = document.getElementById('azVal'),
				amagVal = document.getElementById('amagVal'),
				amagHPFVal = document.getElementById('amagHPFVal'),
				ball = document.getElementById('ball')

			let motionGranted = false,
				streaming = false
			let startT,
				lastT,
				n = 0,
				sumDt = 0,
				gx = 0,
				gy = 0,
				gz = 0,
				lastWrite = 0

			function setStatus(txt, on) {
				statusEl.textContent = txt
				led.className = 'led ' + (on ? 'on' : 'off')
			}
			function syncButtons() {
				btnStart.disabled = !motionGranted || streaming
				btnStop.disabled = !streaming
			}

			btnStart.disabled = true
			btnPerm.disabled = true
			signInAnonymously(auth)
			onAuthStateChanged(auth, () => {
				btnPerm.disabled = false
				syncButtons()
			})

			btnPerm.onclick = async () => {
				try {
					if (
						typeof DeviceMotionEvent !== 'undefined' &&
						typeof DeviceMotionEvent.requestPermission === 'function'
					) {
						const st = await DeviceMotionEvent.requestPermission()
						if (st !== 'granted') throw 0
					}
					motionGranted = true
					syncButtons()
				} catch {}
			}

			btnStart.onclick = () => {
				if (streaming || !motionGranted) return
				streaming = true
				setStatus('Streaming', true)
				syncButtons()
				startT = performance.now()
				lastT = startT
				n = 0
				sumDt = 0
				gx = gy = gz = 0
				window.addEventListener('devicemotion', onMotion, { passive: true })
			}

			btnStop.onclick = () => {
				if (!streaming) return
				streaming = false
				setStatus('Stopped', false)
				syncButtons()
				window.removeEventListener('devicemotion', onMotion)
			}

			function onMotion(e) {
				if (!streaming) return
				const t = performance.now(),
					dt = (t - lastT) / 1000
				lastT = t

				const a = e.acceleration || e.accelerationIncludingGravity || {}
				const ax = a.x || 0,
					ay = a.y || 0,
					az = a.z || 0

				gx = 0.92 * gx + 0.08 * ax
				gy = 0.92 * gy + 0.08 * ay
				gz = 0.92 * gz + 0.08 * az
				const lx = ax - gx,
					ly = ay - gy,
					lz = az - gz

				const amag = Math.hypot(ax, ay, az)
				const amagHPF = Math.hypot(lx, ly, lz)

				if (n > 0) sumDt += dt
				n++
				timeVal.textContent = ((t - startT) / 1000).toFixed(3)
				dtVal.textContent = (dt * 1000).toFixed(1)
				nVal.textContent = n
				hzVal.textContent = n > 1 ? (1 / (sumDt / (n - 1))).toFixed(2) : '—'
				axVal.textContent = ax.toFixed(2)
				ayVal.textContent = ay.toFixed(2)
				azVal.textContent = az.toFixed(2)
				amagVal.textContent = amag.toFixed(2)
				amagHPFVal.textContent = amagHPF.toFixed(2)

				const bx = Math.max(-100, Math.min(100, lx * 3)),
					by = Math.max(-60, Math.min(60, ly * 3))
				ball.style.transform = `translate(calc(-50% + ${bx}px), calc(-50% + ${by}px))`

				const now = performance.now()
				if (now - lastWrite >= 100) {
					lastWrite = now
					addDoc(colAccel, {
						ts: serverTimestamp(),
						time: (t - startT) / 1000,
						ax,
						ay,
						az,
						lx,
						ly,
						lz,
						amag,
						amagHPF,
					}).catch(() => {})
				}
			}

			window.onbeforeunload = () => {
				if (streaming) btnStop.click()
			}
			document.onvisibilitychange = () => {
				if (document.hidden && streaming) btnStop.click()
			}

			setStatus('Stopped', false)
		</script>
	</body>
</html>
