<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Accelerometer Logger</title>
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}
			:root {
				--bg: #0f172a;
				--card: #0b1225;
				--ink: #e5e7eb;
				--muted: #9ca3af;
				--accent: #22d3ee;
				--ok: #10b981;
				--border: #1f2937;
			}
			html,
			body {
				margin: 0;
				height: 100%;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Helvetica, Arial;
				background: var(--bg);
				color: var(--ink);
				display: flex;
				justify-content: center;
				align-items: flex-start;
			}
			main.card {
				width: 100%;
				max-width: 900px;
				margin: 20px;
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 18px;
				padding: 20px;
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
			}
			h1 {
				margin: 0 0 8px;
				text-align: center;
				font-size: 22px;
			}
			.row {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 14px;
				margin-bottom: 12px;
				padding: 0 10px;
			}
			.btncol {
				display: grid;
				grid-template-columns: 1fr;
				gap: 10px;
				width: 100%;
				max-width: 560px;
			}
			button {
				all: unset;
				display: block;
				width: 100%;
				cursor: pointer;
				font-weight: 600;
				padding: 14px 16px;
				border-radius: 12px;
				text-align: center;
				background: #1f2937;
				border: 1px solid #293241;
			}
			button.primary {
				background: var(--accent);
				color: #052b33;
				border-color: #0ea5b6;
			}
			button.warn {
				color: #fca5a5;
			}
			button[disabled] {
				opacity: 0.45;
				cursor: not-allowed;
			}
			.led {
				width: 10px;
				height: 10px;
				border-radius: 50%;
				display: inline-block;
				margin-right: 8px;
				vertical-align: middle;
			}
			.on {
				background: var(--ok);
				box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
			}
			.off {
				background: #374151;
			}
			.grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
				gap: 10px;
				margin-top: 12px;
			}
			.tile {
				background: #0b142a;
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 8px 6px 10px;
				text-align: center;
			}
			.label {
				color: var(--muted);
				font-size: 12px;
				margin-bottom: 4px;
			}
			.val {
				font-variant-numeric: tabular-nums;
				font-size: 22px;
			}
			.ballWrap {
				margin-top: 18px;
				height: 160px;
				background: #081021;
				border: 1px solid #14203b;
				border-radius: 14px;
				position: relative;
				overflow: hidden;
			}
			.ball {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				position: absolute;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				background: radial-gradient(
					circle at 30% 30%,
					#fff 0,
					#abdff5 25%,
					#22d3ee 70%,
					#0ea5b6 100%
				);
				box-shadow: 0 6px 18px rgba(34, 211, 238, 0.35);
			}
		</style>
	</head>
	<body>
		<main class="card">
			<h1>Accelerometer Logger</h1>

			<div class="row">
				<span id="led" class="led off"></span>
				<span id="status">Idle</span>
			</div>

			<div class="row">
				<div class="btncol">
					<button id="btnPermMotion" class="primary">Grant Motion</button>
				</div>
			</div>

			<div class="row">
				<div class="btncol">
					<button id="btnStart" disabled>Start</button>
					<button id="btnStop" disabled class="warn">Stop</button>
					<button id="btnCloud" disabled>Start Cloud Stream</button>
				</div>
			</div>

			<div class="grid">
				<div class="tile">
					<div class="label">Time (s)</div>
					<div id="timeVal" class="val">0.000</div>
				</div>
				<div class="tile">
					<div class="label">Interval (ms)</div>
					<div id="dtVal" class="val">—</div>
				</div>
				<div class="tile">
					<div class="label">Samples</div>
					<div id="nVal" class="val">0</div>
				</div>
				<div class="tile">
					<div class="label">Hz</div>
					<div id="hzVal" class="val">—</div>
				</div>
			</div>
			<div class="grid">
				<div class="tile">
					<div class="label">ax</div>
					<div id="axVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">ay</div>
					<div id="ayVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">az</div>
					<div id="azVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">|a|</div>
					<div id="amagVal" class="val">0.00</div>
				</div>
				<div class="tile">
					<div class="label">HPF |a|</div>
					<div id="amagHPFVal" class="val">0.00</div>
				</div>
			</div>

			<div class="ballWrap"><div id="ball" class="ball"></div></div>
		</main>

		<script type="module">
			import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'
			import {
				getAuth,
				signInAnonymously,
				onAuthStateChanged,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js'
			import {
				getFirestore,
				collection,
				addDoc,
				serverTimestamp,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'

			const firebaseConfig = {
				apiKey: 'AIzaSyAu7YQkG2xRPNs9aGN4TUS3_LpInye72WA',
				authDomain: 'uc-assignment-3-7ac2a.firebaseapp.com',
				projectId: 'uc-assignment-3-7ac2a',
				storageBucket: 'uc-assignment-3-7ac2a.firebasestorage.app',
				messagingSenderId: '369697845903',
				appId: '1:369697845903:web:05bccb3b0e7ba24c65b6fa',
				measurementId: 'G-9BNGZDZ8VQ',
			}
			const app = initializeApp(firebaseConfig)
			const auth = getAuth(app)
			const db = getFirestore(app)
			const colAccel = collection(db, 'accelerometerData')

			const led = document.getElementById('led'),
				statusEl = document.getElementById('status')
			const btnPermMotion = document.getElementById('btnPermMotion')
			const btnStart = document.getElementById('btnStart'),
				btnStop = document.getElementById('btnStop'),
				btnCloud = document.getElementById('btnCloud')
			const timeVal = document.getElementById('timeVal'),
				dtVal = document.getElementById('dtVal'),
				nVal = document.getElementById('nVal'),
				hzVal = document.getElementById('hzVal')
			const axVal = document.getElementById('axVal'),
				ayVal = document.getElementById('ayVal'),
				azVal = document.getElementById('azVal'),
				amagVal = document.getElementById('amagVal'),
				amagHPFVal = document.getElementById('amagHPFVal')
			const ball = document.getElementById('ball')

			let motionGranted = false,
				isActive = false,
				cloudMode = false
			let startT,
				lastT,
				n = 0,
				sumDt = 0,
				gx = 0,
				gy = 0,
				gz = 0,
				lastWrite = 0

			function setStatus(t, on = false) {
				statusEl.textContent = t
				led.className = 'led ' + (on ? 'on' : 'off')
			}
			function enableStart() {
				btnStart.disabled = !motionGranted
			}

			btnStart.disabled = true
			btnPermMotion.disabled = true
			signInAnonymously(auth)
			onAuthStateChanged(auth, () => {
				btnPermMotion.disabled = false
				enableStart()
			})

			btnPermMotion.onclick = async () => {
				try {
					if (
						typeof DeviceMotionEvent !== 'undefined' &&
						typeof DeviceMotionEvent.requestPermission === 'function'
					) {
						const st = await DeviceMotionEvent.requestPermission()
						if (st !== 'granted') throw 0
					}
					motionGranted = true
					enableStart()
				} catch {}
			}

			btnStart.onclick = () => {
				if (isActive) return
				isActive = true
				startT = performance.now()
				lastT = startT
				n = 0
				sumDt = 0
				gx = gy = gz = 0
				btnStart.disabled = true
				btnStop.disabled = false
				btnCloud.disabled = false
				setStatus('Recording', true)
				window.addEventListener('devicemotion', onMotion, { passive: true })
			}
			btnStop.onclick = () => {
				if (!isActive) return
				isActive = false
				window.removeEventListener('devicemotion', onMotion, { passive: true })
				btnStart.disabled = false
				btnStop.disabled = true
				btnCloud.disabled = true
				cloudMode = false
				btnCloud.textContent = 'Start Cloud Stream'
				setStatus('Stopped')
			}
			btnCloud.onclick = () => {
				cloudMode = !cloudMode
				btnCloud.textContent = cloudMode ? 'Streaming…' : 'Start Cloud Stream'
			}

			function onMotion(e) {
				if (!isActive || !motionGranted) return
				const t = performance.now(),
					dt = (t - lastT) / 1000
				lastT = t
				const a = e.acceleration || e.accelerationIncludingGravity || {},
					ax = a.x || 0,
					ay = a.y || 0,
					az = a.z || 0
				gx = 0.92 * gx + 0.08 * ax
				gy = 0.92 * gy + 0.08 * ay
				gz = 0.92 * gz + 0.08 * az
				const lx = ax - gx,
					ly = ay - gy,
					lz = az - gz
				const amag = Math.hypot(ax, ay, az),
					amagHPF = Math.hypot(lx, ly, lz)

				if (n > 0) sumDt += dt
				n++
				timeVal.textContent = ((t - startT) / 1000).toFixed(3)
				dtVal.textContent = (dt * 1000).toFixed(1)
				nVal.textContent = n
				hzVal.textContent = n > 1 ? (1 / (sumDt / (n - 1))).toFixed(2) : '—'
				axVal.textContent = ax.toFixed(2)
				ayVal.textContent = ay.toFixed(2)
				azVal.textContent = az.toFixed(2)
				amagVal.textContent = amag.toFixed(2)
				amagHPFVal.textContent = amagHPF.toFixed(2)

				const bx = Math.max(-100, Math.min(100, lx * 3)),
					by = Math.max(-60, Math.min(60, ly * 3))
				ball.style.transform = `translate(calc(-50% + ${bx}px), calc(-50% + ${by}px))`

				if (cloudMode && motionGranted) {
					const now = performance.now()
					if (now - lastWrite >= 100) {
						lastWrite = now
						addDoc(colAccel, {
							ts: serverTimestamp(),
							time: (t - startT) / 1000,
							ax,
							ay,
							az,
							lx,
							ly,
							lz,
							amag,
							amagHPF,
						}).catch(() => {})
					}
				}
			}

			window.onbeforeunload = () => {
				if (isActive) btnStop.click()
			}
			document.onvisibilitychange = () => {
				if (document.hidden && isActive) btnStop.click()
			}
			setStatus('Idle')
		</script>
	</body>
</html>
