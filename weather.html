<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Weather Logger</title>
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}
			:root {
				--bg: #0b1021;
				--panel: #0e152b;
				--card: #0b142a;
				--ink: #e7eaf0;
				--muted: #9aa3b2;
				--accent: #22d3ee;
				--accent-ink: #052b33;
				--border: #1b2740;
				--ok: #10b981;
			}
			html,
			body {
				margin: 0;
				height: 100%;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Helvetica, Arial;
				background: var(--bg);
				color: var(--ink);
			}
			body {
				display: flex;
				justify-content: center;
				align-items: flex-start;
				padding: max(16px, env(safe-area-inset-top)) 16px
					max(16px, env(safe-area-inset-bottom));
				-webkit-text-size-adjust: 100%;
			}
			main.card {
				width: 100%;
				max-width: 440px;
				background: var(--panel);
				border: 1px solid var(--border);
				border-radius: 18px;
				padding: 16px;
				box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
				overflow: hidden;
			}
			h1 {
				margin: 0 0 10px;
				text-align: center;
				font-size: 22px;
			}
			.row {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 14px;
				margin: 0 0 12px;
				padding: 0 10px;
			}
			.row.status {
				gap: 8px;
				font-size: 14px;
				color: var(--muted);
			}
			.led {
				width: 9px;
				height: 9px;
				border-radius: 50%;
			}
			.led.on {
				background: var(--ok);
				box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.18);
			}
			.led.off {
				background: #44506b;
			}
			.btncol {
				display: grid;
				grid-template-columns: 1fr;
				gap: 10px;
				width: 100%;
				max-width: 460px;
			}
			button {
				-webkit-appearance: none;
				appearance: none;
				display: block;
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;
				cursor: pointer;
				user-select: none;
				-webkit-tap-highlight-color: transparent;
				font: inherit;
				font-weight: 700;
				letter-spacing: 0.2px;
				text-align: center;
				padding: 14px 16px;
				border-radius: 12px;
				background: #152036;
				border: 1px solid #21304c;
				color: var(--ink);
				transition: transform 0.06s ease, border-color 0.15s ease,
					background 0.15s ease;
			}
			button:active {
				transform: translateY(1px);
			}
			button.primary {
				background: var(--accent);
				color: var(--accent-ink);
				border-color: #0ea5b6;
			}
			button.warn {
				color: #fda4a4;
			}
			button[disabled] {
				opacity: 0.55;
				cursor: not-allowed;
			}
			.grid {
				display: grid;
				gap: 12px;
				margin-top: 12px;
				grid-template-columns: repeat(2, minmax(0, 1fr));
			}
			@media (min-width: 500px) {
				.grid {
					grid-template-columns: repeat(3, minmax(0, 1fr));
				}
			}
			.tile {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 10px 8px;
				text-align: center;
				min-height: 80px;
				display: flex;
				flex-direction: column;
				justify-content: center;
			}
			.label {
				color: var(--muted);
				font-size: 12px;
				margin-bottom: 4px;
			}
			.val {
				font-variant-numeric: tabular-nums;
				font-size: 22px;
			}
		</style>
	</head>
	<body>
		<main class="card">
			<h1>Weather Logger</h1>

			<div class="row status">
				<span id="led" class="led off"></span>
				<span id="status">Stopped</span>
			</div>

			<div class="row">
				<div class="btncol">
					<button id="btnPermLocation" class="primary">Grant Location</button>
					<button id="btnStart" disabled>Start Streaming</button>
					<button id="btnStop" disabled class="warn">Stop Streaming</button>
				</div>
			</div>

			<div class="grid">
				<div class="tile">
					<div class="label">Temp</div>
					<div class="val">
						<span id="wTemp">--</span>
						Â°C
						<span id="wIcon">â›…</span>
					</div>
					<div id="wDesc" class="label">â€”</div>
				</div>
				<div class="tile">
					<div class="label">Wind</div>
					<div class="val">
						<span id="wWind">--</span>
						km/h
					</div>
					<div class="label">
						Dir
						<span id="wDir">--</span>
						Â° |
						<span id="wDay">Day/Night</span>
					</div>
				</div>
				<div class="tile">
					<div class="label">Last Weather</div>
					<div id="wLast" class="val">â€”</div>
				</div>
				<div class="tile">
					<div class="label">Lat,Lon</div>
					<div id="wLL" class="val">â€”</div>
				</div>
			</div>
		</main>

		<script type="module">
			import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'
			import {
				getAuth,
				signInAnonymously,
				onAuthStateChanged,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js'
			import {
				getFirestore,
				collection,
				addDoc,
				serverTimestamp,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'

			const firebaseConfig = {
				apiKey: 'AIzaSyAu7YQkG2xRPNs9aGN4TUS3_LpInye72WA',
				authDomain: 'uc-assignment-3-7ac2a.firebaseapp.com',
				projectId: 'uc-assignment-3-7ac2a',
				storageBucket: 'uc-assignment-3-7ac2a.firebasestorage.app',
				messagingSenderId: '369697845903',
				appId: '1:369697845903:web:05bccb3b0e7ba24c65b6fa',
				measurementId: 'G-9BNGZDZ8VQ',
			}

			const app = initializeApp(firebaseConfig)
			const auth = getAuth(app)
			const db = getFirestore(app)
			const colWeather = collection(db, 'weatherData')

			const led = document.getElementById('led'),
				statusEl = document.getElementById('status')
			const btnPerm = document.getElementById('btnPermLocation')
			const btnStart = document.getElementById('btnStart')
			const btnStop = document.getElementById('btnStop')

			const wTemp = document.getElementById('wTemp'),
				wIcon = document.getElementById('wIcon'),
				wDesc = document.getElementById('wDesc'),
				wWind = document.getElementById('wWind'),
				wDir = document.getElementById('wDir'),
				wDay = document.getElementById('wDay'),
				wLast = document.getElementById('wLast'),
				wLL = document.getElementById('wLL')

			let locationGranted = false,
				streaming = false,
				weatherTimer = null

			function setStatus(txt, on) {
				statusEl.textContent = txt
				led.className = 'led ' + (on ? 'on' : 'off')
			}
			function syncButtons() {
				btnStart.disabled = !locationGranted || streaming
				btnStop.disabled = !streaming
			}

			btnStart.disabled = true
			btnPerm.disabled = true
			signInAnonymously(auth)
			onAuthStateChanged(auth, () => {
				btnPerm.disabled = false
				syncButtons()
			})

			btnPerm.onclick = async () => {
				try {
					await new Promise((res, rej) =>
						navigator.geolocation.getCurrentPosition(
							() => res(),
							() => rej(),
							{ enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
						)
					)
					locationGranted = true
					syncButtons()
				} catch {}
			}

			btnStart.onclick = () => {
				if (streaming || !locationGranted) return
				streaming = true
				setStatus('Streaming', true)
				syncButtons()
				startWeather()
			}

			btnStop.onclick = () => {
				if (!streaming) return
				streaming = false
				setStatus('Stopped', false)
				syncButtons()
				stopWeather()
			}

			async function fetchWeatherOnce() {
				if (!streaming || !locationGranted) return
				let lat, lon
				try {
					const p = await new Promise((res, rej) =>
						navigator.geolocation.getCurrentPosition(res, rej, {
							enableHighAccuracy: true,
							timeout: 8000,
							maximumAge: 0,
						})
					)
					lat = p.coords.latitude
					lon = p.coords.longitude
				} catch {
					return
				}

				try {
					const r = await fetch(
						`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
					)
					const cw = (await r.json()).current_weather
					if (!cw) return

					const M = {
						0: ['Clear', 'â˜€ï¸'],
						1: ['Mainly Clear', 'ðŸŒ¤ï¸'],
						2: ['Partly Cloudy', 'â›…'],
						3: ['Overcast', 'â˜ï¸'],
						61: ['Light Rain', 'ðŸŒ§ï¸'],
						63: ['Rain', 'ðŸŒ§ï¸'],
						65: ['Heavy Rain', 'â›ˆï¸'],
					}
					const d = M[cw.weathercode] || ['Unknown', 'ðŸŒ¡ï¸']

					wTemp.textContent = cw.temperature
					wIcon.textContent = d[1]
					wDesc.textContent = d[0]
					wWind.textContent = cw.windspeed
					wDir.textContent = cw.winddirection
					wDay.textContent = cw.is_day ? 'Day' : 'Night'
					wLast.textContent = new Date().toLocaleTimeString()
					wLL.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`

					addDoc(colWeather, {
						ts: serverTimestamp(),
						lat,
						lon,
						temperature: cw.temperature,
						wind: cw.windspeed,
						dir: cw.winddirection,
						code: cw.weathercode,
						is_day: !!cw.is_day,
					}).catch(() => {})
				} catch {}
			}

			function startWeather() {
				stopWeather()
				weatherTimer = setInterval(fetchWeatherOnce, 30000)
				fetchWeatherOnce()
			}
			function stopWeather() {
				if (weatherTimer) {
					clearInterval(weatherTimer)
					weatherTimer = null
				}
			}

			window.onbeforeunload = () => {
				if (streaming) btnStop.click()
			}
			document.onvisibilitychange = () => {
				if (document.hidden && streaming) btnStop.click()
			}

			setStatus('Stopped', false)
		</script>
	</body>
</html>
