<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Weather Logger</title>
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}
			:root {
				--bg: #0f172a;
				--card: #0b1225;
				--ink: #e5e7eb;
				--muted: #9ca3af;
				--accent: #22d3ee;
				--ok: #10b981;
				--border: #1f2937;
			}
			html,
			body {
				margin: 0;
				height: 100%;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Helvetica, Arial;
				background: var(--bg);
				color: var(--ink);
				display: flex;
				justify-content: center;
				align-items: flex-start;
			}
			main.card {
				width: 100%;
				max-width: 700px;
				margin: 20px;
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 18px;
				padding: 20px;
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
			}
			h1 {
				margin: 0 0 8px;
				text-align: center;
				font-size: 22px;
			}
			.row {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 14px;
				margin-bottom: 12px;
				padding: 0 10px;
			}
			.btncol {
				display: grid;
				grid-template-columns: 1fr;
				gap: 10px;
				width: 100%;
				max-width: 460px;
			}
			button {
				all: unset;
				display: block;
				width: 100%;
				cursor: pointer;
				font-weight: 600;
				padding: 14px 16px;
				border-radius: 12px;
				text-align: center;
				background: #1f2937;
				border: 1px solid #293241;
			}
			button.primary {
				background: var(--accent);
				color: #052b33;
				border-color: #0ea5b6;
			}
			button.warn {
				color: #fca5a5;
			}
			button[disabled] {
				opacity: 0.45;
				cursor: not-allowed;
			}
			.led {
				width: 10px;
				height: 10px;
				border-radius: 50%;
				display: inline-block;
				margin-right: 8px;
			}
			.on {
				background: var(--ok);
				box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
			}
			.off {
				background: #374151;
			}
			.grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
				gap: 10px;
				margin-top: 12px;
			}
			.tile {
				background: #0b142a;
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 8px 6px 10px;
				text-align: center;
			}
			.label {
				color: var(--muted);
				font-size: 12px;
				margin-bottom: 4px;
			}
			.val {
				font-variant-numeric: tabular-nums;
				font-size: 22px;
			}
		</style>
	</head>
	<body>
		<main class="card">
			<h1>Weather Logger</h1>

			<div class="row">
				<span id="led" class="led off"></span>
				<span id="status">Idle</span>
			</div>

			<div class="row">
				<div class="btncol">
					<button id="btnPermLocation" class="primary">Grant Location</button>
				</div>
			</div>

			<div class="row">
				<div class="btncol">
					<button id="btnStart" disabled>Start</button>
					<button id="btnStop" disabled class="warn">Stop</button>
					<button id="btnCloud" disabled>Start Cloud Stream</button>
				</div>
			</div>

			<div class="grid">
				<div class="tile">
					<div class="label">Temp</div>
					<div class="val">
						<span id="wTemp">--</span>
						Â°C
						<span id="wIcon">â›…</span>
					</div>
					<div id="wDesc" class="label">â€”</div>
				</div>
				<div class="tile">
					<div class="label">Wind</div>
					<div class="val">
						<span id="wWind">--</span>
						km/h
					</div>
					<div class="label">
						Dir
						<span id="wDir">--</span>
						Â° |
						<span id="wDay">Day/Night</span>
					</div>
				</div>
				<div class="tile">
					<div class="label">Last Weather</div>
					<div id="wLast" class="val">â€”</div>
				</div>
				<div class="tile">
					<div class="label">Lat,Lon</div>
					<div id="wLL" class="val">â€”</div>
				</div>
			</div>
		</main>

		<script type="module">
			import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js'
			import {
				getAuth,
				signInAnonymously,
				onAuthStateChanged,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js'
			import {
				getFirestore,
				collection,
				addDoc,
				serverTimestamp,
			} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'

			const firebaseConfig = {
				apiKey: 'AIzaSyAu7YQkG2xRPNs9aGN4TUS3_LpInye72WA',
				authDomain: 'uc-assignment-3-7ac2a.firebaseapp.com',
				projectId: 'uc-assignment-3-7ac2a',
				storageBucket: 'uc-assignment-3-7ac2a.firebasestorage.app',
				messagingSenderId: '369697845903',
				appId: '1:369697845903:web:05bccb3b0e7ba24c65b6fa',
				measurementId: 'G-9BNGZDZ8VQ',
			}
			const app = initializeApp(firebaseConfig)
			const auth = getAuth(app)
			const db = getFirestore(app)
			const colWeather = collection(db, 'weatherData')

			const led = document.getElementById('led'),
				statusEl = document.getElementById('status')
			const btnPermLocation = document.getElementById('btnPermLocation')
			const btnStart = document.getElementById('btnStart'),
				btnStop = document.getElementById('btnStop'),
				btnCloud = document.getElementById('btnCloud')
			const wTemp = document.getElementById('wTemp'),
				wIcon = document.getElementById('wIcon'),
				wDesc = document.getElementById('wDesc'),
				wWind = document.getElementById('wWind'),
				wDir = document.getElementById('wDir'),
				wDay = document.getElementById('wDay'),
				wLast = document.getElementById('wLast'),
				wLL = document.getElementById('wLL')

			let locationGranted = false,
				isActive = false,
				cloudMode = false,
				weatherTimer = null

			function setStatus(t, on = false) {
				statusEl.textContent = t
				led.className = 'led ' + (on ? 'on' : 'off')
			}
			function enableStart() {
				btnStart.disabled = !locationGranted
			}

			btnStart.disabled = true
			btnPermLocation.disabled = true
			signInAnonymously(auth)
			onAuthStateChanged(auth, () => {
				btnPermLocation.disabled = false
				enableStart()
			})

			btnPermLocation.onclick = async () => {
				try {
					await new Promise((res, rej) =>
						navigator.geolocation.getCurrentPosition(
							() => res(),
							() => rej(),
							{ enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
						)
					)
					locationGranted = true
					enableStart()
				} catch {}
			}

			btnStart.onclick = () => {
				if (isActive) return
				isActive = true
				btnStart.disabled = true
				btnStop.disabled = false
				btnCloud.disabled = false
				setStatus('Recording', true)
				startWeather()
			}
			btnStop.onclick = () => {
				if (!isActive) return
				isActive = false
				stopWeather()
				btnStart.disabled = false
				btnStop.disabled = true
				btnCloud.disabled = true
				cloudMode = false
				btnCloud.textContent = 'Start Cloud Stream'
				setStatus('Stopped')
			}
			btnCloud.onclick = () => {
				cloudMode = !cloudMode
				btnCloud.textContent = cloudMode ? 'Streamingâ€¦' : 'Start Cloud Stream'
			}

			async function fetchWeatherOnce() {
				if (!locationGranted || !isActive) return
				let lat, lon
				try {
					const p = await new Promise((res, rej) =>
						navigator.geolocation.getCurrentPosition(res, rej, {
							enableHighAccuracy: true,
							timeout: 8000,
							maximumAge: 0,
						})
					)
					lat = p.coords.latitude
					lon = p.coords.longitude
				} catch {
					return
				}

				try {
					const r = await fetch(
						`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
					)
					const cw = (await r.json()).current_weather
					if (!cw) return
					const M = {
						0: ['Clear', 'â˜€ï¸'],
						1: ['Mainly Clear', 'ðŸŒ¤ï¸'],
						2: ['Partly Cloudy', 'â›…'],
						3: ['Overcast', 'â˜ï¸'],
						61: ['Light Rain', 'ðŸŒ§ï¸'],
						63: ['Rain', 'ðŸŒ§ï¸'],
						65: ['Heavy Rain', 'â›ˆï¸'],
					}
					const d = M[cw.weathercode] || ['Unknown', 'ðŸŒ¡ï¸']
					wTemp.textContent = cw.temperature
					wIcon.textContent = d[1]
					wDesc.textContent = d[0]
					wWind.textContent = cw.windspeed
					wDir.textContent = cw.winddirection
					wDay.textContent = cw.is_day ? 'Day' : 'Night'
					wLast.textContent = new Date().toLocaleTimeString()
					wLL.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`
					if (cloudMode && locationGranted) {
						addDoc(colWeather, {
							ts: serverTimestamp(),
							lat,
							lon,
							temperature: cw.temperature,
							wind: cw.windspeed,
							dir: cw.winddirection,
							code: cw.weathercode,
							is_day: !!cw.is_day,
						}).catch(() => {})
					}
				} catch {}
			}

			function startWeather() {
				stopWeather()
				weatherTimer = setInterval(fetchWeatherOnce, 30000)
				fetchWeatherOnce()
			}
			function stopWeather() {
				if (weatherTimer) {
					clearInterval(weatherTimer)
					weatherTimer = null
				}
			}

			window.onbeforeunload = () => {
				if (isActive) btnStop.click()
			}
			document.onvisibilitychange = () => {
				if (document.hidden && isActive) btnStop.click()
			}
			setStatus('Idle')
		</script>
	</body>
</html>
